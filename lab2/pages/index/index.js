Page({
    data: {
      region: ['安徽省', '芜湖市', '镜湖区'],
      now: {
        temp: 0,
        cond_txt: '未知', 
        cond_code: '999',
        hum: 0,
        pres: 0,
        vis: 0,
        wind_dir: 0,
        wind_spd: 0,
        wind_sc: 0
      }
    },
    
    // 获取城市代码的函数
    getCityCode: function(province, city) {
      // 完整的城市代码映射库
      const cityMap = {
        '北京市': {
          '北京市': '101010100'
        },
        '天津市': {
          '天津市': '101030100'
        },
        '河北省': {
          '石家庄市': '101090101',
          '唐山市': '101090201',
          '秦皇岛市': '101091101',
          '邯郸市': '101090401',
          '邢台市': '101090501',
          '保定市': '101090601',
          '张家口市': '101090701',
          '承德市': '101090801',
          '沧州市': '101090901',
          '廊坊市': '101091001',
          '衡水市': '101091101'
        },
        '山西省': {
          '太原市': '101100101',
          '大同市': '101100201',
          '阳泉市': '101100301',
          '长治市': '101100401',
          '晋城市': '101100501',
          '朔州市': '101100601',
          '晋中市': '101100701',
          '运城市': '101100801',
          '忻州市': '101100901',
          '临汾市': '101101001',
          '吕梁市': '101101100'
        },
        '内蒙古自治区': {
          '呼和浩特市': '101080101',
          '包头市': '101080201',
          '乌海市': '101080301',
          '赤峰市': '101080401',
          '通辽市': '101080501',
          '鄂尔多斯市': '101080601',
          '呼伦贝尔市': '101080701',
          '巴彦淖尔市': '101080801',
          '乌兰察布市': '101080901'
        },
        '辽宁省': {
          '沈阳市': '101070101',
          '大连市': '101070201',
          '鞍山市': '101070301',
          '抚顺市': '101070401',
          '本溪市': '101070501',
          '丹东市': '101070601',
          '锦州市': '101070701',
          '营口市': '101070801',
          '阜新市': '101070901',
          '辽阳市': '101071001',
          '盘锦市': '101071101',
          '铁岭市': '101071201',
          '朝阳市': '101071301',
          '葫芦岛市': '101071401'
        },
        '吉林省': {
          '长春市': '101060101',
          '吉林市': '101060201',
          '四平市': '101060301',
          '辽源市': '101060401',
          '通化市': '101060501',
          '白山市': '101060601',
          '松原市': '101060701',
          '白城市': '101060801',
          '延边朝鲜族自治州': '101060901'
        },
        '黑龙江省': {
          '哈尔滨市': '101050101',
          '齐齐哈尔市': '101050201',
          '鸡西市': '101050301',
          '鹤岗市': '101050401',
          '双鸭山市': '101050501',
          '大庆市': '101050601',
          '伊春市': '101050701',
          '佳木斯市': '101050801',
          '七台河市': '101050901',
          '牡丹江市': '101051001',
          '黑河市': '101051101',
          '绥化市': '101051201'
        },
        '上海市': {
          '上海市': '101020100'
        },
        '江苏省': {
          '南京市': '101190101',
          '无锡市': '101190201',
          '徐州市': '101190301',
          '常州市': '101190401',
          '苏州市': '101190501',
          '南通市': '101190601',
          '连云港市': '101191301',
          '淮安市': '101190801',
          '盐城市': '101190901',
          '扬州市': '101191001',
          '镇江市': '101191101',
          '泰州市': '101191201',
          '宿迁市': '101191301'
        },
        '浙江省': {
          '杭州市': '101210101',
          '宁波市': '101210201',
          '温州市': '101210301',
          '嘉兴市': '101210401',
          '湖州市': '101210501',
          '绍兴市': '101210601',
          '金华市': '101210701',
          '衢州市': '101210801',
          '舟山市': '101210901',
          '台州市': '101211001',
          '丽水市': '101211101'
        },
        '安徽省': {
          '合肥市': '101220101',
          '芜湖市': '101220201',
          '蚌埠市': '101220301',
          '淮南市': '101220401',
          '马鞍山市': '101220501',
          '淮北市': '101220601',
          '铜陵市': '101220701',
          '安庆市': '101220801',
          '黄山市': '101220901',
          '滁州市': '101221001',
          '阜阳市': '101221101',
          '宿州市': '101221201',
          '六安市': '101221301',
          '亳州市': '101221401',
          '池州市': '101221501',
          '宣城市': '101221601'
        },
        '福建省': {
          '福州市': '101230101',
          '厦门市': '101230201',
          '莆田市': '101230301',
          '三明市': '101230401',
          '泉州市': '101230501',
          '漳州市': '101230601',
          '南平市': '101230701',
          '龙岩市': '101230801',
          '宁德市': '101230901'
        },
        '江西省': {
          '南昌市': '101240101',
          '景德镇市': '101240201',
          '萍乡市': '101240301',
          '九江市': '101240401',
          '新余市': '101240501',
          '鹰潭市': '101240601',
          '赣州市': '101240701',
          '吉安市': '101240801',
          '宜春市': '101240901',
          '抚州市': '101241001',
          '上饶市': '101241101'
        },
        '山东省': {
          '济南市': '101120101',
          '青岛市': '101120201',
          '淄博市': '101120301',
          '枣庄市': '101120401',
          '东营市': '101120501',
          '烟台市': '101120601',
          '潍坊市': '101120701',
          '济宁市': '101120801',
          '泰安市': '101120901',
          '威海市': '101121001',
          '日照市': '101121101',
          '莱芜市': '101121201',
          '临沂市': '101121301',
          '德州市': '101121401',
          '聊城市': '101121501',
          '滨州市': '101121601',
          '菏泽市': '101121701'
        },
        '河南省': {
          '郑州市': '101180101',
          '开封市': '101180201',
          '洛阳市': '101180301',
          '平顶山市': '101180401',
          '安阳市': '101180501',
          '鹤壁市': '101180601',
          '新乡市': '101180701',
          '焦作市': '101180801',
          '濮阳市': '101180901',
          '许昌市': '101181001',
          '漯河市': '101181101',
          '三门峡市': '101181201',
          '南阳市': '101181301',
          '商丘市': '101181401',
          '信阳市': '101181501',
          '周口市': '101181601',
          '驻马店市': '101181701'
        },
        '湖北省': {
          '武汉市': '101200101',
          '黄石市': '101200201',
          '十堰市': '101200301',
          '宜昌市': '101200401',
          '襄阳市': '101200501',
          '鄂州市': '101200601',
          '荆门市': '101200701',
          '孝感市': '101200801',
          '荆州市': '101200901',
          '黄冈市': '101201001',
          '咸宁市': '101201101',
          '随州市': '101201201'
        },
        '湖南省': {
          '长沙市': '101250101',
          '株洲市': '101250201',
          '湘潭市': '101250301',
          '衡阳市': '101250401',
          '邵阳市': '101250501',
          '岳阳市': '101250601',
          '常德市': '101250701',
          '张家界市': '101250801',
          '益阳市': '101250901',
          '郴州市': '101251001',
          '永州市': '101251101',
          '怀化市': '101251201',
          '娄底市': '101251301'
        },
        '广东省': {
          '广州市': '101280101',
          '韶关市': '101280201',
          '深圳市': '101280601',
          '珠海市': '101280701',
          '汕头市': '101280501',
          '佛山市': '101280800',
          '江门市': '101281001',
          '湛江市': '101281101',
          '茂名市': '101281201',
          '肇庆市': '101281301',
          '惠州市': '101281401',
          '梅州市': '101281501',
          '汕尾市': '101281601',
          '河源市': '101281701',
          '阳江市': '101281801',
          '清远市': '101281901',
          '东莞市': '101282001',
          '中山市': '101282101',
          '潮州市': '101282201',
          '揭阳市': '101282301',
          '云浮市': '101282401'
        },
        '广西壮族自治区': {
          '南宁市': '101300101',
          '柳州市': '101300201',
          '桂林市': '101300301',
          '梧州市': '101300401',
          '北海市': '101300501',
          '防城港市': '101301401',
          '钦州市': '101300601',
          '贵港市': '101300701',
          '玉林市': '101300801',
          '百色市': '101300901',
          '贺州市': '101301001',
          '河池市': '101301101',
          '来宾市': '101301201',
          '崇左市': '101301301'
        },
        '海南省': {
          '海口市': '101310101',
          '三亚市': '101310201',
          '三沙市': '101310301',
          '儋州市': '101310401'
        },
        '重庆市': {
          '重庆市': '101040100'
        },
        '四川省': {
          '成都市': '101270101',
          '自贡市': '101270201',
          '攀枝花市': '101270301',
          '泸州市': '101270401',
          '德阳市': '101270501',
          '绵阳市': '101270601',
          '广元市': '101270701',
          '遂宁市': '101270801',
          '内江市': '101270901',
          '乐山市': '101271001',
          '南充市': '101271101',
          '眉山市': '101271201',
          '宜宾市': '101271301',
          '广安市': '101271401',
          '达州市': '101271501',
          '雅安市': '101271601',
          '巴中市': '101271701',
          '资阳市': '101271801'
        },
        '贵州省': {
          '贵阳市': '101260101',
          '六盘水市': '101260201',
          '遵义市': '101260301',
          '安顺市': '101260401',
          '毕节市': '101260501',
          '铜仁市': '101260601'
        },
        '云南省': {
          '昆明市': '101290101',
          '曲靖市': '101290201',
          '玉溪市': '101290301',
          '保山市': '101290401',
          '昭通市': '101290501',
          '丽江市': '101290601',
          '普洱市': '101290701',
          '临沧市': '101290801'
        },
        '西藏自治区': {
          '拉萨市': '101140101',
          '日喀则市': '101140201',
          '昌都市': '101140301',
          '林芝市': '101140401',
          '山南市': '101140501',
          '那曲市': '101140601'
        },
        '陕西省': {
          '西安市': '101110101',
          '铜川市': '101110201',
          '宝鸡市': '101110301',
          '咸阳市': '101110401',
          '渭南市': '101110501',
          '延安市': '101110601',
          '汉中市': '101110701',
          '榆林市': '101110801',
          '安康市': '101110901',
          '商洛市': '101111001'
        },
        '甘肃省': {
          '兰州市': '101160101',
          '嘉峪关市': '101160201',
          '金昌市': '101160301',
          '白银市': '101160401',
          '天水市': '101160501',
          '武威市': '101160601',
          '张掖市': '101160701',
          '平凉市': '101160801',
          '酒泉市': '101160901',
          '庆阳市': '101161001',
          '定西市': '101161101',
          '陇南市': '101161201'
        },
        '青海省': {
          '西宁市': '101150101',
          '海东市': '101150201'
        },
        '宁夏回族自治区': {
          '银川市': '101170101',
          '石嘴山市': '101170201',
          '吴忠市': '101170301',
          '固原市': '101170401',
          '中卫市': '101170501'
        },
        '新疆维吾尔自治区': {
          '乌鲁木齐市': '101130101',
          '克拉玛依市': '101130201',
          '吐鲁番市': '101130301',
          '哈密市': '101130401'
        },
        '香港特别行政区': {
          '香港': '101320101'
        },
        '澳门特别行政区': {
          '澳门': '101330101'
        },
        '台湾省': {
          '台北市': '101340101',
          '高雄市': '101340201',
          '台中市': '101340401'
        }
      };
      
      if (cityMap[province] && cityMap[province][city]) {
        return cityMap[province][city];
      }
      return '101220201'; // 默认返回芜湖市代码
    },
    
    regionChange: function(e) {
      this.setData({region: e.detail.value});
      this.getWeather();
    },
    
    getWeather: function() {
      var that = this;
      const locationCode = this.getCityCode(this.data.region[0], this.data.region[1]);
      console.log('当前地区:', this.data.region, '城市代码:', locationCode);
      wx.request({
        url: 'https://mn5xmd96fj.re.qweatherapi.com/v7/weather/now',
        data: {
          location: locationCode, 
          key: 'f40427d91c8c43a9a7db17aede262b09'
        },
        success: function(res) {
          console.log('API返回数据:', res.data);
          console.log('now对象详细信息:', JSON.stringify(res.data.now, null, 2));
          if (res.data && res.data.now) {
            that.setData({
              now: {
                temp: res.data.now.temp || 0,
                cond_txt: res.data.now.text || '未知',
                cond_code: res.data.now.icon || '999',
                hum: res.data.now.humidity || 0,
                pres: res.data.now.pressure || 0,
                vis: res.data.now.vis || 0,
                wind_dir: res.data.now.windDir || 0,
                wind_spd: res.data.now.windSpeed || 0,
                wind_sc: res.data.now.windScale || 0
              }
            });
            console.log('更新后的数据:', that.data.now);
          } 
        },
      });
    },
    onLoad: function(options) {
      this.getWeather();
    },
  });