<!--index.wxml-->
<view class="page">
  <!-- ä¸»è¦å†…å®¹åŒºåŸŸ - æ ¹æ®å½“å‰ Tab æ˜¾ç¤ºä¸åŒå†…å®¹ -->
  <view class="main-content">
    <!-- ä¸»é¡µ Tab å†…å®¹ -->
    <view class="tab-content" wx:if="{{currentTab === 0}}">
      <!-- ä¸»é¡µé…å›¾ -->
      <view class="hero-image">
        <image class="hero-img" src="/images/ä¸»é¡µé…å›¾.png" mode="aspectFill"></image>
      </view>
      
      <!-- å°é»‘æ¿æ–‡å­—æ¡† -->
      <view class="blackboard">
        <text class="blackboard-text">è®°å½•å±äºä½ çš„å¤§å­¦å›å¿†</text>
      </view>
      
      <view class="game-actions">
        <button class="game-btn" bindtap="startNewGame">å¼€å§‹æ¸¸æˆ</button>
        <button class="game-btn" bindtap="continueGame">ç»§ç»­æ¸¸æˆ</button>
      </view>
    </view>

    <!-- å†å² Tab å†…å®¹ -->
    <view class="tab-content" wx:if="{{currentTab === 1}}">
      <view class="history-container">
        <!-- é¡¶éƒ¨æ ‡é¢˜ -->
        <view class="history-header">
          <button class="history-title-btn" bindtap="clearAllHistory">
            <text class="history-title-text">æ¸¸æˆå†å²</text>
          </button>
        </view>
        
        <!-- ä¸­é—´å¯æ»‘åŠ¨å±•ç¤ºæ¡† -->
        <view class="history-content">
          <view class="history-box">
            <scroll-view class="history-scroll" scroll-y="true">
              <view wx:if="{{gameHistory.length === 0}}" class="history-empty">
                <text class="empty-text">æš‚æ— æ¸¸æˆè®°å½•</text>
                <text class="empty-tip">å®Œæˆä¸€å±€æ¸¸æˆåï¼Œè®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</text>
              </view>
              
              <view wx:else>
                <view class="history-item" wx:for="{{gameHistory}}" wx:key="id">
                  <view class="history-header-item">
                    <view class="player-info">
                      <text class="player-name">{{item.playerName}}</text>
                      <text class="character-detail">{{item.character.gender}} Â· {{item.character.major}}</text>
                      <view class="achievements" wx:if="{{item.achievements.length > 0}}">
                        <text class="achievements-text">ğŸ† {{item.achievements.join('ã€')}}</text>
                      </view>
                    </view>
                    <text class="completion-time">{{item.completedTime}}</text>
                  </view>
                </view>
              </view>
            </scroll-view>
          </view>
        </view>
      </view>
    </view>

    <!-- å›å¿† Tab å†…å®¹ -->
    <view class="tab-content" wx:if="{{currentTab === 2}}">
      <view class="memory-container">
        <!-- é¡¶éƒ¨æ·»åŠ å›å¿†æŒ‰é’® -->
        <view class="memory-header">
          <button class="add-memory-btn" bindtap="showAddModal">æ·»åŠ å›å¿†</button>
        </view>
        
        <!-- ä¸­é—´å¯æ»‘åŠ¨å±•ç¤ºæ¡† -->
        <view class="memory-content">
          <view class="memory-box">
            <scroll-view class="memory-scroll" scroll-y="true">
              <view wx:if="{{recentMemories.length === 0}}" class="memory-empty">
                <text class="empty-text">è¿˜æ²¡æœ‰è®°å½•ä»»ä½•å›å¿†å‘¢</text>
              </view>
              
              <view wx:else>
                <view class="memory-item" wx:for="{{recentMemories}}" wx:key="id" bindtap="viewMemoryDetail" data-id="{{item.id}}">
                  <text class="memory-text">{{item.semester}} {{item.summary}}</text>
                  <text class="memory-time">{{item.createTime ? item.createTime.split('T')[0] : 'æœªçŸ¥æ—¶é—´'}}</text>
                </view>
              </view>
            </scroll-view>
          </view>
        </view>
        
        <!-- åº•éƒ¨ç´«è‰²æ–‡æ¡ˆ -->
        <view class="memory-footer">
          <text class="memory-slogan">å›å¿†çš„ç”»é¢åœ¨è¡ç€ç§‹åƒ</text>
        </view>
      </view>
    </view>

    <!-- ä¸ªäºº Tab å†…å®¹ -->
    <view class="tab-content" wx:if="{{currentTab === 3}}">
      <view class="profile-section">
        <!-- æœªç™»å½•çŠ¶æ€ -->
        <view class="login-section" wx:if="{{!isLoggedIn}}">
          <view class="login-avatar">
            <image class="avatar-placeholder" src="/images/default-avatar.svg" mode="aspectFill"></image>
          </view>
          <text class="login-tip">ç™»å½•åæŸ¥çœ‹ä¸ªäººä¿¡æ¯</text>
          <button class="login-btn" bindtap="wechatLogin">
            <text class="login-icon"></text>
            <text class="login-text">å¾®ä¿¡å¿«æ·ç™»å½•</text>
          </button>
        </view>
        
        <!-- å·²ç™»å½•çŠ¶æ€ -->
         <view class="user-profile" wx:if="{{isLoggedIn}}">
           <view class="user-header">
             <image class="user-avatar" src="{{userInfo.avatarUrl || '/images/default-avatar.svg'}}" mode="aspectFill" bindtap="changeAvatar"></image>
             <view class="avatar-edit-tip">ç‚¹å‡»æ›´æ¢å¤´åƒ</view>
           </view>
           
           <view class="user-details">
             <view class="detail-item" bindtap="editNickname">
               <text class="detail-icon"></text>
               <text class="detail-label">æ˜µç§°</text>
               <text class="detail-value">{{userInfo.nickName || 'æœªè®¾ç½®'}}</text>
               <text class="detail-arrow">></text>
             </view>
             
             <view class="detail-item" bindtap="editBirthday">
               <text class="detail-icon"></text>
               <text class="detail-label">ç”Ÿæ—¥</text>
               <text class="detail-value">{{userInfo.birthday || 'æœªè®¾ç½®'}}</text>
               <text class="detail-arrow">></text>
             </view>
           </view>
           
           <!-- ç›¸å†Œé›†å’Œå…³äºæŒ‰é’® -->
           <view class="action-buttons">
             <button class="action-btn" bindtap="openPhotoAlbum">
               <text class="action-icon">ğŸ“¸</text>
               <text class="action-text">ç›¸å†Œé›†</text>
             </button>
             <button class="action-btn" bindtap="openAbout">
               <text class="action-icon">â„¹ï¸</text>
               <text class="action-text">å…³äº</text>
             </button>
           </view>
          
          <button class="logout-btn" bindtap="logout">
            <text class="logout-text">é€€å‡ºç™»å½•</text>
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- æ·»åŠ å›å¿†å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showModal}}" bindtap="hideAddModal">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">æ·»åŠ å›å¿†</text>
        <text class="modal-close" bindtap="hideAddModal">Ã—</text>
      </view>
      
      <view class="modal-body">
        <!-- äº‹ä»¶æ¦‚æ‹¬ -->
        <view class="form-item">
          <text class="form-label">äº‹ä»¶æ¦‚æ‹¬</text>
          <input class="form-input" placeholder="ä¸€å¥è¯æ¦‚æ‹¬è¿™ä¸ªå›å¿†" value="{{formData.summary}}" bindinput="onSummaryInput" maxlength="20" />
          <text class="char-count">{{formData.summary.length}}/20</text>
        </view>
        
        <!-- å­¦æœŸé€‰æ‹© -->
        <view class="form-item">
          <text class="form-label">å­¦æœŸ</text>
          <picker class="form-picker" mode="selector" range="{{semesterOptions}}" value="{{semesterIndex}}" bindchange="onSemesterChange">
            <view class="picker-text">{{semesterOptions[semesterIndex]}}</view>
          </picker>
        </view>
        
        <!-- è¯¦ç»†æè¿° -->
        <view class="form-item">
          <text class="form-label">è¯¦ç»†æè¿°</text>
          <textarea class="form-textarea" placeholder="è¯¦ç»†æè¿°è¿™ä¸ªå›å¿†..." value="{{formData.description}}" bindinput="onDescriptionInput" maxlength="200" />
          <text class="char-count">{{formData.description.length}}/200</text>
        </view>
        
        <!-- å¿ƒæƒ…è®°å½• -->
        <view class="form-item">
          <text class="form-label">å¿ƒæƒ…è®°å½•</text>
          <textarea class="form-textarea" placeholder="å½“æ—¶çš„å¿ƒæƒ…å¦‚ä½•ï¼Ÿ" value="{{formData.mood}}" bindinput="onMoodInput" maxlength="100" />
          <text class="char-count">{{formData.mood.length}}/100</text>
        </view>
        
        <!-- æ—¶é—´è®°å½• -->
        <view class="form-item">
          <text class="form-label">æ—¶é—´è®°å½•</text>
          <input class="form-input" placeholder="å¤§æ¦‚ä»€ä¹ˆæ—¶å€™å‘ç”Ÿçš„ï¼Ÿ" value="{{formData.time}}" bindinput="onTimeInput" maxlength="30" />
        </view>
        
        <!-- ä¸Šä¼ å›¾ç‰‡ -->
        <view class="form-item">
          <text class="form-label">ä¸Šä¼ å›¾ç‰‡</text>
          <view class="image-upload">
            <!-- å›¾ç‰‡é¢„è§ˆåŒºåŸŸ -->
            <view class="image-preview" wx:if="{{selectedImages.length > 0}}">
              <view class="image-item" wx:for="{{selectedImages}}" wx:key="index">
                <image class="preview-image" src="{{item.tempFilePath}}" mode="aspectFill" bindtap="previewImage" data-index="{{index}}"></image>
                <view class="image-delete" bindtap="removeImage" data-index="{{index}}">Ã—</view>
              </view>
            </view>
            
            <!-- æ·»åŠ å›¾ç‰‡æŒ‰é’® -->
            <view class="upload-btn" wx:if="{{selectedImages.length < 9}}" bindtap="chooseImages">
              <text class="upload-icon">ğŸ“·</text>
              <text class="upload-text">{{selectedImages.length > 0 ? 'ç»§ç»­æ·»åŠ ' : 'æ·»åŠ å›¾ç‰‡'}}</text>
            </view>
            
            <!-- å›¾ç‰‡æ•°é‡æç¤º -->
            <text class="upload-tip" wx:if="{{selectedImages.length > 0}}">å·²é€‰æ‹© {{selectedImages.length}}/9 å¼ å›¾ç‰‡</text>
            <text class="upload-tip" wx:else>æœ€å¤šå¯é€‰æ‹©9å¼ å›¾ç‰‡</text>
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="cancel-btn" bindtap="hideAddModal">å–æ¶ˆ</button>
        <button class="confirm-btn" bindtap="addMemory" disabled="{{uploadingImages}}">{{uploadingImages ? 'ä¸Šä¼ ä¸­...' : 'ç¡®è®¤æ·»åŠ '}}</button>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨Tabå¯¼èˆª -->
  <view class="tab-bar">
    <view class="tab-item {{currentTab === 0 ? 'active' : ''}}" bindtap="switchTab" data-index="0">
      <text class="tab-text">ä¸»é¡µ</text>
    </view>
    <view class="tab-item {{currentTab === 1 ? 'active' : ''}}" bindtap="switchTab" data-index="1">
      <text class="tab-text">å†å²</text>
    </view>
    <view class="tab-item {{currentTab === 2 ? 'active' : ''}}" bindtap="switchTab" data-index="2">
      <text class="tab-text">å›å¿†</text>
    </view>
    <view class="tab-item {{currentTab === 3 ? 'active' : ''}}" bindtap="switchTab" data-index="3">
      <text class="tab-text">ä¸ªäºº</text>
    </view>
  </view>
</view>
