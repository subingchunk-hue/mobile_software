<!--index.wxml-->
<view class="page">
  <!-- 主要内容区域 - 根据当前 Tab 显示不同内容 -->
  <view class="main-content">
    <!-- 主页 Tab 内容 -->
    <view class="tab-content" wx:if="{{currentTab === 0}}">
      <!-- 主页配图 -->
      <view class="hero-image">
        <image class="hero-img" src="/images/主页配图.png" mode="aspectFill"></image>
      </view>
      
      <!-- 小黑板文字框 -->
      <view class="blackboard">
        <text class="blackboard-text">记录属于你的大学回忆</text>
      </view>
      
      <view class="game-actions">
        <button class="game-btn" bindtap="startNewGame">开始游戏</button>
        <button class="game-btn" bindtap="continueGame">继续游戏</button>
      </view>
    </view>

    <!-- 历史 Tab 内容 -->
    <view class="tab-content" wx:if="{{currentTab === 1}}">
      <view class="history-container">
        <!-- 顶部标题 -->
        <view class="history-header">
          <button class="history-title-btn" bindtap="clearAllHistory">
            <text class="history-title-text">游戏历史</text>
          </button>
        </view>
        
        <!-- 中间可滑动展示框 -->
        <view class="history-content">
          <view class="history-box">
            <scroll-view class="history-scroll" scroll-y="true">
              <view wx:if="{{gameHistory.length === 0}}" class="history-empty">
                <text class="empty-text">暂无游戏记录</text>
                <text class="empty-tip">完成一局游戏后，记录将显示在这里</text>
              </view>
              
              <view wx:else>
                <view class="history-item" wx:for="{{gameHistory}}" wx:key="id">
                  <view class="history-header-item">
                    <view class="player-info">
                      <text class="player-name">{{item.playerName}}</text>
                      <text class="character-detail">{{item.character.gender}} · {{item.character.major}}</text>
                      <view class="achievements" wx:if="{{item.achievements.length > 0}}">
                        <text class="achievements-text">🏆 {{item.achievements.join('、')}}</text>
                      </view>
                    </view>
                    <text class="completion-time">{{item.completedTime}}</text>
                  </view>
                </view>
              </view>
            </scroll-view>
          </view>
        </view>
      </view>
    </view>

    <!-- 回忆 Tab 内容 -->
    <view class="tab-content" wx:if="{{currentTab === 2}}">
      <view class="memory-container">
        <!-- 顶部添加回忆按钮 -->
        <view class="memory-header">
          <button class="add-memory-btn" bindtap="showAddModal">添加回忆</button>
        </view>
        
        <!-- 中间可滑动展示框 -->
        <view class="memory-content">
          <view class="memory-box">
            <scroll-view class="memory-scroll" scroll-y="true">
              <view wx:if="{{recentMemories.length === 0}}" class="memory-empty">
                <text class="empty-text">还没有记录任何回忆呢</text>
              </view>
              
              <view wx:else>
                <view class="memory-item" wx:for="{{recentMemories}}" wx:key="id" bindtap="viewMemoryDetail" data-id="{{item.id}}">
                  <text class="memory-text">{{item.semester}} {{item.summary}}</text>
                  <text class="memory-time">{{item.createTime ? item.createTime.split('T')[0] : '未知时间'}}</text>
                </view>
              </view>
            </scroll-view>
          </view>
        </view>
        
        <!-- 底部紫色文案 -->
        <view class="memory-footer">
          <text class="memory-slogan">回忆的画面在荡着秋千</text>
        </view>
      </view>
    </view>

    <!-- 个人 Tab 内容 -->
    <view class="tab-content" wx:if="{{currentTab === 3}}">
      <view class="profile-section">
        <!-- 未登录状态 -->
        <view class="login-section" wx:if="{{!isLoggedIn}}">
          <view class="login-avatar">
            <image class="avatar-placeholder" src="/images/default-avatar.svg" mode="aspectFill"></image>
          </view>
          <text class="login-tip">登录后查看个人信息</text>
          <button class="login-btn" bindtap="wechatLogin">
            <text class="login-icon"></text>
            <text class="login-text">微信快捷登录</text>
          </button>
        </view>
        
        <!-- 已登录状态 -->
         <view class="user-profile" wx:if="{{isLoggedIn}}">
           <view class="user-header">
             <image class="user-avatar" src="{{userInfo.avatarUrl || '/images/default-avatar.svg'}}" mode="aspectFill" bindtap="changeAvatar"></image>
             <view class="avatar-edit-tip">点击更换头像</view>
           </view>
           
           <view class="user-details">
             <view class="detail-item" bindtap="editNickname">
               <text class="detail-icon"></text>
               <text class="detail-label">昵称</text>
               <text class="detail-value">{{userInfo.nickName || '未设置'}}</text>
               <text class="detail-arrow">></text>
             </view>
             
             <view class="detail-item" bindtap="editBirthday">
               <text class="detail-icon"></text>
               <text class="detail-label">生日</text>
               <text class="detail-value">{{userInfo.birthday || '未设置'}}</text>
               <text class="detail-arrow">></text>
             </view>
           </view>
           
           <!-- 相册集和关于按钮 -->
           <view class="action-buttons">
             <button class="action-btn" bindtap="openPhotoAlbum">
               <text class="action-icon">📸</text>
               <text class="action-text">相册集</text>
             </button>
             <button class="action-btn" bindtap="openAbout">
               <text class="action-icon">ℹ️</text>
               <text class="action-text">关于</text>
             </button>
           </view>
          
          <button class="logout-btn" bindtap="logout">
            <text class="logout-text">退出登录</text>
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- 添加回忆弹窗 -->
  <view class="modal-overlay" wx:if="{{showModal}}" bindtap="hideAddModal">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">添加回忆</text>
        <text class="modal-close" bindtap="hideAddModal">×</text>
      </view>
      
      <view class="modal-body">
        <!-- 事件概括 -->
        <view class="form-item">
          <text class="form-label">事件概括</text>
          <input class="form-input" placeholder="一句话概括这个回忆" value="{{formData.summary}}" bindinput="onSummaryInput" maxlength="20" />
          <text class="char-count">{{formData.summary.length}}/20</text>
        </view>
        
        <!-- 学期选择 -->
        <view class="form-item">
          <text class="form-label">学期</text>
          <picker class="form-picker" mode="selector" range="{{semesterOptions}}" value="{{semesterIndex}}" bindchange="onSemesterChange">
            <view class="picker-text">{{semesterOptions[semesterIndex]}}</view>
          </picker>
        </view>
        
        <!-- 详细描述 -->
        <view class="form-item">
          <text class="form-label">详细描述</text>
          <textarea class="form-textarea" placeholder="详细描述这个回忆..." value="{{formData.description}}" bindinput="onDescriptionInput" maxlength="200" />
          <text class="char-count">{{formData.description.length}}/200</text>
        </view>
        
        <!-- 心情记录 -->
        <view class="form-item">
          <text class="form-label">心情记录</text>
          <textarea class="form-textarea" placeholder="当时的心情如何？" value="{{formData.mood}}" bindinput="onMoodInput" maxlength="100" />
          <text class="char-count">{{formData.mood.length}}/100</text>
        </view>
        
        <!-- 时间记录 -->
        <view class="form-item">
          <text class="form-label">时间记录</text>
          <input class="form-input" placeholder="大概什么时候发生的？" value="{{formData.time}}" bindinput="onTimeInput" maxlength="30" />
        </view>
        
        <!-- 上传图片 -->
        <view class="form-item">
          <text class="form-label">上传图片</text>
          <view class="image-upload">
            <!-- 图片预览区域 -->
            <view class="image-preview" wx:if="{{selectedImages.length > 0}}">
              <view class="image-item" wx:for="{{selectedImages}}" wx:key="index">
                <image class="preview-image" src="{{item.tempFilePath}}" mode="aspectFill" bindtap="previewImage" data-index="{{index}}"></image>
                <view class="image-delete" bindtap="removeImage" data-index="{{index}}">×</view>
              </view>
            </view>
            
            <!-- 添加图片按钮 -->
            <view class="upload-btn" wx:if="{{selectedImages.length < 9}}" bindtap="chooseImages">
              <text class="upload-icon">📷</text>
              <text class="upload-text">{{selectedImages.length > 0 ? '继续添加' : '添加图片'}}</text>
            </view>
            
            <!-- 图片数量提示 -->
            <text class="upload-tip" wx:if="{{selectedImages.length > 0}}">已选择 {{selectedImages.length}}/9 张图片</text>
            <text class="upload-tip" wx:else>最多可选择9张图片</text>
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="cancel-btn" bindtap="hideAddModal">取消</button>
        <button class="confirm-btn" bindtap="addMemory" disabled="{{uploadingImages}}">{{uploadingImages ? '上传中...' : '确认添加'}}</button>
      </view>
    </view>
  </view>

  <!-- 底部Tab导航 -->
  <view class="tab-bar">
    <view class="tab-item {{currentTab === 0 ? 'active' : ''}}" bindtap="switchTab" data-index="0">
      <text class="tab-text">主页</text>
    </view>
    <view class="tab-item {{currentTab === 1 ? 'active' : ''}}" bindtap="switchTab" data-index="1">
      <text class="tab-text">历史</text>
    </view>
    <view class="tab-item {{currentTab === 2 ? 'active' : ''}}" bindtap="switchTab" data-index="2">
      <text class="tab-text">回忆</text>
    </view>
    <view class="tab-item {{currentTab === 3 ? 'active' : ''}}" bindtap="switchTab" data-index="3">
      <text class="tab-text">个人</text>
    </view>
  </view>
</view>
